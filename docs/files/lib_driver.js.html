<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/driver.js - taxi</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="taxi"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/ActiveWindow.html">ActiveWindow</a></li>
            
                <li><a href="../classes/Alert.html">Alert</a></li>
            
                <li><a href="../classes/Browser.html">Browser</a></li>
            
                <li><a href="../classes/Connection.html">Connection</a></li>
            
                <li><a href="../classes/Cookie.html">Cookie</a></li>
            
                <li><a href="../classes/CookieStorage.html">CookieStorage</a></li>
            
                <li><a href="../classes/Driver.html">Driver</a></li>
            
                <li><a href="../classes/Element.html">Element</a></li>
            
                <li><a href="../classes/Frame.html">Frame</a></li>
            
                <li><a href="../classes/GlobalMouse.html">GlobalMouse</a></li>
            
                <li><a href="../classes/GlobalTouch.html">GlobalTouch</a></li>
            
                <li><a href="../classes/IME.html">IME</a></li>
            
                <li><a href="../classes/Keys.html">Keys</a></li>
            
                <li><a href="../classes/LocalStorage.html">LocalStorage</a></li>
            
                <li><a href="../classes/LogEntry.html">LogEntry</a></li>
            
                <li><a href="../classes/Mouse.html">Mouse</a></li>
            
                <li><a href="../classes/Navigator.html">Navigator</a></li>
            
                <li><a href="../classes/Session.html">Session</a></li>
            
                <li><a href="../classes/SessionStorage.html">SessionStorage</a></li>
            
                <li><a href="../classes/Status.html">Status</a></li>
            
                <li><a href="../classes/Taxi.html">Taxi</a></li>
            
                <li><a href="../classes/TimeOut.html">TimeOut</a></li>
            
                <li><a href="../classes/Touch.html">Touch</a></li>
            
                <li><a href="../classes/WindowHandler.html">WindowHandler</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/Core.html">Core</a></li>
            
                <li><a href="../modules/Interaction.html">Interaction</a></li>
            
                <li><a href="../modules/Navigation.html">Navigation</a></li>
            
                <li><a href="../modules/Storage.html">Storage</a></li>
            
                <li><a href="../modules/System.html">System</a></li>
            
                <li><a href="../modules/Taxi.html">Taxi</a></li>
            
                <li><a href="../modules/WebDriver.html">WebDriver</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/driver.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var EventEmitter = require(&#x27;events&#x27;).EventEmitter;
var util = require(&#x27;util&#x27;);
var url = require(&#x27;url&#x27;);

var logMethods = require(&#x27;./log&#x27;);
var JSON = require(&#x27;./json&#x27;);
var when = require(&#x27;./when&#x27;);
var errors = require(&#x27;./errors&#x27;);
var type = require(&#x27;./type&#x27;);

var Connection = require(&#x27;./connection&#x27;);

var Browser = require(&#x27;./browser&#x27;);
var TimeOut = require(&#x27;./timeOut&#x27;);

var Session = require(&#x27;./session&#x27;);
var Status = require(&#x27;./status&#x27;);
var LogEntry = require(&#x27;./logEntry&#x27;);

var SessionStorage = require(&#x27;./sessionStorage&#x27;);


module.exports = Driver;

/**
 * Create a new Driver session, remember to call &#x60;.dispose()&#x60;
 * at the end to terminate the session.
 *
 * @constructor
 * @class Driver
 * @module WebDriver
 * @submodule Core
 * @param {String|Object} remote Request object or URL to selenium-server
 * @param {Object} capabilities See capabilities in {{#crossLink &quot;Session&quot;}}{{/crossLink}}
 * @param {Object} options
 * @param {String} options.mode Mode of web-driver requests (Driver.MODE_SYNC|Driver.MODE_ASYNC)
 * @param {String} [options.base] Base-url
 * @param {String} [options.sessionID]
 * @param {String} [options.logDir]
 * @param {Boolean} [options.logScreen=true]
 */
function Driver (remote, capabilities, options) {
  EventEmitter.call(this);

  type(&#x27;remote&#x27;, remote, &#x27;String|Object&#x27;);
  type(&#x27;capabilities&#x27;, capabilities, &#x27;Object&#x27;);
  type(&#x27;options&#x27;, options, &#x27;Object&#x27;);
  type(&#x27;options.mode&#x27;, options.mode, &#x27;String&#x27;);

  setupDebug(this, options);

  options.remote = remote;
  options.capabilities = capabilities;
  this._options = options;
  this._connection = new Connection(remote, options);
  this._connection.on(&#x27;request&#x27;, function (req) {
    this.emit(&#x27;request&#x27;, req);
  }.bind(this));
  this._connection.on(&#x27;response&#x27;, function (res) {
    this.emit(&#x27;response&#x27;, res);
  }.bind(this));

  if (options.sessionID) {
    this._sessionObj = new Session({ sessionId: options.sessionID, capabilities: capabilities });
  } else {
    this._sessionObj = this._createSession(capabilities);
  }
}
util.inherits(Driver, EventEmitter);


////////////
// Events //
////////////

/**
 * Fired when a request is made
 *
 * @event request
 * @param {Object} request Request options
 */

/**
 * Fired when a response is received
 *
 * @event response
 * @param {Object} response Response data
 */

/**
 * Fired when a public method is called
 *
 * @event method-call
 * @param {Object} event Method event data
 */

/**
 * Fired when the session is destroyed
 *
 * @event disposed
 */


////////////////////
// Static Methods //
////////////////////

/**
 * Gets the selenium-system status
 *
 * @method getStatus
 * @param {String} remote
 * @param {String} mode
 * @return {Status}
 */
Driver.getStatus = function (remote, mode) {
  var request = new Connection(remote, mode);

  return when(when(request.request(&#x27;GET&#x27;, undefined, &#x27;/status&#x27;, undefined, {
    &#x27;Content-Type&#x27;: &#x27;application/json;charset=UTF-8&#x27;
  }), Connection.prototype._parseResponse), function (response) {
    return new Status(response);
  });
};

/**
 * Returns a list of the currently active sessions
 *
 * Note: Appears not to be supported by the selenium-standalone-server!
 *
 * @method getSessions
 * @param {String} remote
 * @param {string} mode
 * @return {Array.&lt;Session&gt;}
 */
Driver.getSessions = function (remote, mode) {
  var request = new Connection(remote, mode);

  return when(when(request.request(&#x27;GET&#x27;, undefined, &#x27;/sessions&#x27;, undefined, {
    &#x27;Content-Type&#x27;: &#x27;application/json;charset=UTF-8&#x27;
  }), Connection.prototype._parseResponse), function (sessions) {
    return sessions.map(function (session) {
      return new Session(session);
    }.bind(this));
  }.bind(this));
};


/////////////////////
// Private Methods //
/////////////////////

/**
 * Returns value according to mode
 *
 * @method _getValue
 * @protected
 * @param {*} [value]
 * @return {*}
 */
Driver.prototype._getValue = function (value) {

  var result;

  switch (this._options.mode) {
    case &#x27;async&#x27;:
      result = require(&#x27;promise&#x27;)(function (resolve) { resolve(value); });
      break;
    case &#x27;sync&#x27;:
      result = value;
      break;
    default:
      throw new Error(&#x27;Expected options.mode to be &quot;async&quot; or &quot;sync&quot; but got &#x27; + JSON.stringify(this._options.mode));
  }

  return result;
};

/**
 * Create a selenium session
 *
 * @method _createSession
 * @private
 * @param {Object} desiredCapabilities
 * @param {Object} [requiredCapabilities]
 * @return {Session}
 */
Driver.prototype._createSession = function (desiredCapabilities, requiredCapabilities) {

  var capabilities = {}, capabilitiesStr;

  capabilities.desiredCapabilities = desiredCapabilities;
  if (requiredCapabilities) {
    capabilities.requiredCapabilities = requiredCapabilities;
  }

  capabilitiesStr = JSON.stringify(capabilities);

  return when(this._connection.request(&#x27;POST&#x27;, undefined, &#x27;/session&#x27;, capabilitiesStr), function (res) {
    return new Session(extractSessionData(res));
  });
};

/**
 * Trigger an event to log the method-call
 *
 * @param {object} event
 * @method _logMethodCall
 * @protected
 */
Driver.prototype._logMethodCall = function (event) {
  if (!event.target) {
    event.target = &#x27;Driver&#x27;;
  }
  when.done(this._session(), function (session) {
    event.sessionID = session.id();
    this.emit(&#x27;method-call&#x27;, event);
  }.bind(this));
};


/**
 * Performs a context dependent JSON request for the current session.
 * The result is parsed for errors.
 *
 * @method _requestJSON
 * @protected
 * @param {String} method
 * @param {String} path
 * @param {*} [body]
 * @param {Object} [options]
 * @return {*}
 */
Driver.prototype._requestJSON = function (method, path, body, options) {
  return this._connection.taxiRequest(this._session(), method, path, body, options);
};


//////////////////
// Enumerations //
//////////////////

/**
 * Sync-mode of web-driver requests
 *
 * @static
 * @property MODE_SYNC
 * @type {string}
 */
Driver.MODE_SYNC = &#x27;sync&#x27;;

/**
 * Async-mode of web-driver requests
 *
 * @static
 * @property MODE_ASYNC
 * @type {string}
 */
Driver.MODE_ASYNC = &#x27;async&#x27;;


/**
 * Status of the HTML5 application cache - Uncached
 *
 * @static
 * @property APPLICATION_CACHE_UNCACHED
 * @type {int}
 */
Driver.APPLICATION_CACHE_UNCACHED = 0;

/**
 * Status of the HTML5 application cache - Idle
 *
 * @static
 * @property APPLICATION_CACHE_IDLE
 * @type {int}
 */
Driver.APPLICATION_CACHE_IDLE = 1;

/**
 * Status of the HTML5 application cache - Checking
 *
 * @static
 * @property APPLICATION_CACHE_CHECKING
 * @type {int}
 */
Driver.APPLICATION_CACHE_CHECKING = 2;

/**
 * Status of the HTML5 application cache - Downloading
 *
 * @static
 * @property APPLICATION_CACHE_DOWNLOADING
 * @type {int}
 */
Driver.APPLICATION_CACHE_DOWNLOADING = 3;

/**
 * Status of the HTML5 application cache - Update-ready
 *
 * @static
 * @property APPLICATION_CACHE_UPDATE_READY
 * @type {int}
 */
Driver.APPLICATION_CACHE_UPDATE_READY = 4;

/**
 * Status of the HTML5 application cache - Obsolete
 *
 * @static
 * @property APPLICATION_CACHE_OBSOLETE
 * @type {int}
 */
Driver.APPLICATION_CACHE_OBSOLETE = 5;


////////////////////
// Public Methods //
////////////////////

/**
 * Get the session object of current session
 *
 * Note: This function call is not logged!
 *
 * @method _session
 * @private
 * @return {Session}
 */
Driver.prototype._session = function () {
  return this._sessionObj;
};

/**
 * Get the session object of current session
 *
 * @method session
 * @return {Session}
 */
Driver.prototype.session = Driver.prototype._session;


/**
 * Gets the browser object.
 * Direct-access. No need to wait.
 *
 * @method browser
 * @return {Browser}
 */
Driver.prototype.browser = function () {
  return new Browser(this);
};


/**
 * Get the time-out object.
 * Direct-access. No need to wait.
 *
 * @method timeOut
 * @return {TimeOut}
 */
Driver.prototype.timeOut = function () {
  return new TimeOut(this);
};


/**
 * Get the status of the html5 application cache
 *
 * @method getApplicationCacheStatus
 * @return {Number}
 */
Driver.prototype.getApplicationCacheStatus = function () {
  return this._requestJSON(&#x27;GET&#x27;, &#x27;/application_cache/status&#x27;);
};


/**
 * Get the log for a given log type. Log buffer is reset after each request.
 *
 * @method getLogs
 * @param {String} logType
 * @return {Array.&lt;LogEntry&gt;}
 */
Driver.prototype.getLogs = function (logType) {
  type(&#x27;logType&#x27;, logType, &#x27;String&#x27;);

  return when(this._requestJSON(&#x27;POST&#x27;, &#x27;/log&#x27;, {
    type: logType
  }), function (logs) {
    return logs.map(function (logEntry) {
      return new LogEntry(logEntry);
    }.bind(this));
  }.bind(this));
};

/**
 * Get available log types
 *
 * @method getLogTypes
 * @return {Array.&lt;String&gt;}
 */
Driver.prototype.getLogTypes = function () {
  return this._requestJSON(&#x27;GET&#x27;, &#x27;/log/types&#x27;);
};


/**
 * End this Driver session
 *
 * @method dispose
 * @param {Object} [status]
 */
Driver.prototype.dispose = function (status) {
  var doDispose = function () {
    return when(this._requestJSON(&#x27;DELETE&#x27;, &#x27;&#x27;), function (res) {
      this.emit(&#x27;disposed&#x27;);
      return res;
    }.bind(this));
  }.bind(this);

  if (status &amp;&amp; (status.passed === true || status.passed === false)) {
    return when(this.sauceJobUpdate(status), doDispose);
  } else {
    return doDispose();
  }
};

/**
 * End this Driver session
 *
 * Alias for &#x60;dispose&#x60;
 * @method quit
 */
Driver.prototype.quit = Driver.prototype.dispose;


/**
 * Get the Session-Storage object.
 * Direct-access. No need to wait.
 *
 * @method sessionStorage
 * @return {SessionStorage}
 */
Driver.prototype.sessionStorage = function () {
  return new SessionStorage(this);
};


/**
 * Sauce Labs Methods
 *
 * @method sauceJobUpdate
 * @param {Object} body
 * @return {Boolean}
 */
Driver.prototype.sauceJobUpdate = function (body) {
  var remote = this._connection._remote;
  var request = this._connection._request_internal.bind(this);

  function makeRequest (session) {
    if (typeof remote !== &#x27;string&#x27;) {
      remote = remote.base;
    }
    if (remote.indexOf(&#x27;saucelabs&#x27;) === -1) {
      return false;
    }
    if (body === undefined) {
      return true;
    }
    var auth = url.parse(remote).auth;

    return when(request({
      method: &#x27;PUT&#x27;,
      uri: &#x27;http://&#x27; + auth + &#x27;@saucelabs.com/rest/v1/&#x27; + auth.split(&#x27;:&#x27;)[0] + &#x27;/jobs/&#x27; + session.id(),
      headers: {
        &#x27;Content-Type&#x27;: &#x27;text/json&#x27;
      },
      body: JSON.stringify(body)
    }), function () {
      return true;
    });
  }

  return when(this._session(), makeRequest);
};

logMethods(Driver.prototype);


///////////////
// Utilities //
///////////////

/**
 * Extract a session ID and the accepted capabilities from a server response
 *
 * @param {Object} res
 * @return {Object} &#x60;{sessionId: String, capabilities: Object}&#x60;
 */
function extractSessionData (res) {
  var body;

  if (res.statusCode !== 200) {
    console.dir(res.headers);
    throw new Error(&#x27;Failed to start a Selenium session. Server responded with status code &#x27; + res.statusCode + &#x27;:\n&#x27; + res.body);
  }

  body = JSON.parse(res.body);
  if (body.status === 0) {
    return { sessionId: body.sessionId, capabilities: body.value };
  } else {
    throw new Error(errors.fromBody(body));
  }
}

/**
 * Setup debug output
 *
 * @param {Driver} driver
 * @param {object} options
 */
function setupDebug (driver, options) {
    var indentation = 0;

    function stringFill (filler, length) {
        var buffer = new Buffer(length);
        buffer.fill(filler);
        return buffer.toString();
    }

    function getIndentation (add) {
        return stringFill(&#x27; &#x27;, (indentation + add) * 2);
    }

    if (options.debug) {
        if (options.httpDebug) {
            driver.on(&#x27;request&#x27;, function (req) {
                console.log(getIndentation(1) + &quot;Request:  &quot;, JSON.stringify(req).substr(0, 5000));
            });
            driver.on(&#x27;response&#x27;, function (res) {
                console.log(getIndentation(1) + &quot;Response: &quot;, JSON.stringify(res).substr(0, 5000));
            });
        }
        driver.on(&#x27;method-call&#x27;, function (event) {
            var msg = event.target;
            indentation = event.indentation;
            if (event.selector) {
                msg += &#x27;(&#x27; + util.inspect(event.selector, {colors: true}) + &#x27;)&#x27;;
            }
            msg += &#x27;.&#x27; + event.name;
            msg += &#x27;(&#x27; + event.args.map(function (a) {
                return util.inspect(a, {colors: true});
            }).join(&#x27;, &#x27;) + &#x27;)&#x27;;
            if (event.result &amp;&amp; typeof event.result !== &#x27;object&#x27;) {
                msg += &#x27; =&gt; &#x27; + util.inspect(event.result, {colors: true});
            }
            console.log(getIndentation(0) + &#x27;[&#x27; + (event.state + stringFill(&#x27; &#x27;, 5)).substr(0, 5) + &#x27;] &#x27; + msg);
            if (event.state.toLowerCase() !== &#x27;start&#x27;) {
                console.log(getIndentation(0) + stringFill(&#x27;-&#x27;, 50));
            }
        });
    }
}
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
